---

interface NowPlaying {
  name: string;
  artistLink: string;
  song: string;
  coverArt: string;
  songLink: string;
}

interface Artist {
  name: string;
  image: string;
}

// Utility function to fetch and parse the music profile data
async function fetchMusicProfileData(): Promise<{ nowPlaying: NowPlaying | null; topArtists: Artist[] }> {
  const response = await fetch("https://volt.fm/solaszn");
  const html = await response.text();

  // console.log('Fetched HTML:', html);

  const nowPlayingMatch = html.match(/<div class="theme-bg-primary min-w-64 max-w-lg rounded-lg p-4 shadow-lg sm:min-w-\[80%\]">([\s\S]*?)<\/div>/);

  let nowPlaying: NowPlaying | null = null;
  if (nowPlayingMatch) {
    const section = nowPlayingMatch[1];

    const songMatch = section.match(/<a href="(\/spotify\/track\/[^"]+)"[^>]*>([^<]+)<\/a>/);

    const artistMatch = section.match(/<a href="(\/spotify\/artist\/[^"]+)"[^>]*>([^<]+)<\/a>/);

    const coverArtMatch = section.match(/style="background-image:url\(([^)]+)\)/);

    // Log matches
    console.log("Song Match:", songMatch);
    console.log("Artist Match:", artistMatch);

    if (coverArtMatch) {
      console.log("Cover Art:", coverArtMatch[1]);
    }

    if (songMatch && artistMatch && coverArtMatch) {
      nowPlaying = {
        name: artistMatch[2],
        artistLink: artistMatch[1],
        song: songMatch[2],
        songLink: songMatch[1],
        coverArt: coverArtMatch[1],
      };
    }
  }

  const topArtistsMatch = html.match(/<h2 class="text-3xl font-extrabold"><a href="\/solaszn\/artists\?time_frame=long"[^>]*>Top Artists<\/a><\/h2>([\s\S]*?)<div class="h-8"><\/div>/);


  const topArtists: Artist[] = [];
  if (topArtistsMatch) {
    const artistMatches = topArtistsMatch[1].matchAll(/<a href="\/artist\/[^"]+"[^>]*><img src="([^"]+)"[^>]*><span class="external-text">([^<]+)<\/span><\/a>/g);

    for (const match of artistMatches) {
      console.log("Artist Match:", match);
      topArtists.push({ name: match[2], image: match[1] });
    }
  }

  return { nowPlaying, topArtists };
}

const { nowPlaying, topArtists } = await fetchMusicProfileData();
// console.log("Fetched Now Playing:", nowPlaying);
---

<div>
  <h1>Music Profile</h1>

  <!-- Now Playing Section -->
  {
    nowPlaying ? (
      <div id="now-playing">
        <h2>Now Playing</h2>
        <img src={nowPlaying.coverArt} alt={`${nowPlaying.song} cover art`} />
        <p>
          <a href={`https://volt.fm${nowPlaying.songLink}`}>{nowPlaying.song}</a> by <a href={`https://volt.fm${nowPlaying.artistLink}`}>{nowPlaying.name}</a>
        </p>
      </div>
    ) : (
      <p id="now-playing">No song currently playing.</p>
    )
  }

  <!-- Top Artists Section -->
  {
    topArtists.length > 0 ? (
      <div>
        <h2>Top Artists</h2>
        <ul>
          {topArtists.map((artist, index) => (
            <li>
              <img src={artist.image} alt={`${artist.name} image`} />
              <p>{artist.name}</p>
            </li>
          ))}
        </ul>
      </div>
    ) : (
      <p>No top artists found.</p>
    )
  }
</div>

<script>
  async function fetchNowPlaying() {
    const response = await fetch("https://volt.fm/solaszn");
    const html = await response.text();

    // Parse Now Playing
    const nowPlayingMatch = html.match(/<div class="theme-bg-primary min-w-64 max-w-lg rounded-lg p-4 shadow-lg sm:min-w-\[80%\]">([\s\S]*?)<\/div>/);

    let nowPlaying = null;
    if (nowPlayingMatch) {
      const section = nowPlayingMatch[1];

      const songMatch = section.match(/<a href="(\/spotify\/track\/[^"]+)"[^>]*>([^<]+)<\/a>/);
      const artistMatch = section.match(/<a href="(\/spotify\/artist\/[^"]+)"[^>]*>([^<]+)<\/a>/);

      const coverArtMatch = section.match(/style="background-image:url\(([^)]+)\)/);

      if (songMatch && artistMatch && coverArtMatch) {
        nowPlaying = {
          name: artistMatch[2],
          artistLink: artistMatch[1],
          song: songMatch[2],
          coverArt: coverArtMatch[1],
          songLink: songMatch[1],
        };
      }
    }

    const nowPlayingDiv = document.getElementById("now-playing");
    if (nowPlaying && nowPlayingDiv) {
      nowPlayingDiv.innerHTML = `
        <h2>Now Playing</h2>
        <img src="${nowPlaying.coverArt}" alt="${nowPlaying.song} cover art" />
        <p>
          <a href="https://volt.fm${nowPlaying.songLink}">${nowPlaying.song}</a> by
          <a href="https://volt.fm${nowPlaying.artistLink}">${nowPlaying.name}</a>
        </p>
      `;
    } else if (nowPlayingDiv) {
      nowPlayingDiv.innerHTML = `<p>No song currently playing.</p>`;
    }
  }

  // Refresh Now Playing every 10 minutes
  setInterval(fetchNowPlaying, 10 * 60 * 1000);
</script>
