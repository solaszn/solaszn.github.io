---
// import { fetch } from "node-fetch";

// Fetch the profile page
const response = await fetch("https://volt.fm/solaszn?time_frame=short");
const html = await response.text();

// Parse the HTML to extract the "Now Playing" and "Top Artists" data
const nowPlaying = extractNowPlaying(html);
const topArtists = extractTopArtists(html);

// Helper function to extract the "Now Playing" data
function extractNowPlaying(html: string) {
  const nowPlayingRegex = /<div class="theme-bg-primary[^>]*>[\s\S]*?<div class="group\/track-player-overlay[^>]*style="background-image:url\(([^)]+)\)[\s\S]*?<a href="([^"]+)"[^>]*>([^<]+)<\/a>[\s\S]*?<a href="([^"]+)"[^>]*>([^<]+)<\/a>/;
  const match = html.match(nowPlayingRegex);

  if (match) {
    return {
      song: match[3].trim(),
      songLink: match[2].trim(),
      artist: match[5].trim(),
      artistLink: match[4].trim(),
      coverArt: match[1].trim(),
    };
  }
  return null;
}

// Helper function to extract the "Top Artists" data
function extractTopArtists(html: string) {
  const topArtistsRegex = /<a href="\/artist\/[^"]+"[^>]*>[\s\S]*?<img src="([^"]+)"[^>]*>[\s\S]*?<span class="external-text">([^<]+)<\/span>/g;
  const matches = [...html.matchAll(topArtistsRegex)];

  return matches.slice(0, 10).map((match) => ({
    name: match[2].trim(),
    image: match[1].trim(),
  }));
}
---

<div>
  <h1>Now Playing</h1>
  {
    nowPlaying ? (
      <div id="now-playing">
        <img src={nowPlaying.coverArt} alt="Cover Art" width="100" height="100" />
        <p>
          <strong>Song:</strong> <a href={nowPlaying.songLink}>{nowPlaying.song}</a>
          <br />
          <strong>Artist:</strong> <a href={nowPlaying.artistLink}>{nowPlaying.artist}</a>
        </p>
      </div>
    ) : (
      <p>No song is currently playing.</p>
    )
  }

  <h1>Top Artists</h1>
  <ul>
    {
      topArtists.map((artist, index) => (
        <li>
          <img src={artist.image} alt={artist.name} width="50" height="50" />
          <span>{artist.name}</span>
        </li>
      ))
    }
  </ul>
</div>

<script>
  // Refresh the "Now Playing" section every 10 minutes
  setInterval(async () => {
    const response = await fetch("https://volt.fm/solaszn?time_frame=short");
    const data = await response.json();

    const nowPlayingDiv = document.getElementById("now-playing");
    // console.log ("Now Playing: ", data.nowPlaying)

    if (data.nowPlaying && nowPlayingDiv) {
      nowPlayingDiv.innerHTML = `
            <div>
              <img src="${data.nowPlaying.coverArt}" alt="Cover Art" width="100" height="100" />
              <p>
                <strong>Song:</strong> <a href="${data.nowPlaying.songLink}">${data.nowPlaying.song}</a><br />
                <strong>Artist:</strong> <a href="${data.nowPlaying.artistLink}">${data.nowPlaying.artist}</a>
              </p>
            </div>
          `;
    } else if (nowPlayingDiv) {
      nowPlayingDiv.innerHTML = "<p>No song is currently playing.</p>";
    }
  }, 600000); // 10 minutes
</script>
