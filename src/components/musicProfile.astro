---
import Image from "astro/components/Image.astro";

// Initialize empty data for nowPlaying and topArtists
let nowPlaying = null;
let topArtists = [];
---

<div>
  <!-- Now Playing Section -->
  <div id="now-playing" class="flex gap-4 items-center">
    <div class="loader w-24 h-24 rounded-full"></div>
    <div>
      <p class="loader h-5 w-40 mb-2"></p>
      <p class="loader h-5 w-32"></p>
    </div>
  </div>

  <!-- Top Artists Section -->
  <h1 class="mt-8 text-xl font-bold">Top Artists</h1>
  <ul id="top-artists" class="flex flex-wrap gap-4 mt-4">
    {Array.from({ length: 5 }).map(() => (
      <li class="flex flex-col items-center">
        <div class="loader w-16 h-16 rounded-full mb-2"></div>
        <div class="loader h-5 w-20"></div>
      </li>
    ))}
  </ul>
</div>

<script>
  const apiEndpoint = '/api/music-profile';
  async function fetchMusicProfile() {
    try {
      // Fetch data from the server-side API proxy
      const response = await fetch(`${apiEndpoint}`);
      if (!response.ok) {
        console.error('Failed to fetch music profile data.');
        return;
      }

      const { nowPlaying: nowPlayingData, topArtists: topArtistsData } = await response.json();

      // Update Now Playing
      const nowPlayingElement = document.getElementById('now-playing');
      if (nowPlayingData && nowPlayingElement) {
        nowPlayingElement.innerHTML = `
          <div class="w-24 h-24 rounded-full overflow-hidden">
            <img src="${nowPlayingData.coverArt}" alt="Cover Art" class="w-full h-full object-cover" />
          </div>
          <div>
            <p><strong>Song:</strong> <a href="https://volt.fm${nowPlayingData.songLink}" target="_blank">${nowPlayingData.song}</a></p>
            <p><strong>Artist:</strong> <a href="https://volt.fm${nowPlayingData.artistLink}" target="_blank">${nowPlayingData.artist}</a></p>
          </div>
        `;
      } else if (nowPlayingElement) {
        nowPlayingElement.innerHTML = '<p>No song is currently playing.</p>';
      }

      // Update Top Artists
      const topArtistsElement = document.getElementById('top-artists');
      if (topArtistsData && topArtistsElement) {
        topArtistsElement.innerHTML = topArtistsData
          .map(
            (artist:any) => `
              <li class="flex flex-col items-center">
                <div class="w-16 h-16 rounded-full overflow-hidden">
                  <img src="${artist.image}" alt="${artist.name}" class="w-full h-full object-cover" />
                </div>
                <p>${artist.name}</p>
              </li>
            `
          )
          .join('');
      } else if (topArtistsElement) {
        topArtistsElement.innerHTML = '<p>No top artists found.</p>';
      }
    } catch (error) {
      console.error('Error fetching music profile:', error);
    }
  }

  // Fetch data 2 seconds after the page loads
  window.addEventListener('load', () => {
    setTimeout(fetchMusicProfile, 300);
  });
</script>
